
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local LocalPlayer = game:GetService("Players").LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local HttpService = game:GetService("HttpService")

local DexorUI = {
	Elements = {},
	ThemeObjects = {},
	Connections = {},
	Flags = {},
	Themes = {
		Default = {
			Main = Color3.fromRGB(22, 25, 34),
			Second = Color3.fromRGB(34, 38, 49),
			Stroke = Color3.fromRGB(65, 75, 93),
			Divider = Color3.fromRGB(60, 60, 60),
			Text = Color3.fromRGB(255, 255, 255),
			TextDark = Color3.fromRGB(155, 155, 155)
		}
	},
	SelectedTheme = "Default",
	Folder = nil,
	SaveCfg = false
}

getgenv().gethui = function() return game.CoreGui end

local function AddConnection(Signal, Function)
	if not DexorUI:IsRunning() then return end
	local SignalConnect = Signal:Connect(Function)
	table.insert(DexorUI.Connections, SignalConnect)
	return SignalConnect
end

function DexorUI:IsRunning()
	return game.CoreGui:FindFirstChild("DexorUI") ~= nil
end

task.spawn(function()
	while DexorUI:IsRunning() do wait() end
	for _, Connection in next, DexorUI.Connections do Connection:Disconnect() end
end)

local function AddDraggingFunctionality(DragPoint, Main)
	pcall(function()
		local Dragging, DragInput, MousePos, FramePos = false
		DragPoint.InputBegan:Connect(function(Input)
			if Input.UserInputType == Enum.UserInputType.MouseButton1 then
				Dragging = true
				MousePos = Input.Position
				FramePos = Main.Position
				Input.Changed:Connect(function()
					if Input.UserInputState == Enum.UserInputState.End then Dragging = false end
				end)
			end
		end)
		DragPoint.InputChanged:Connect(function(Input)
			if Input.UserInputType == Enum.UserInputType.MouseMovement then DragInput = Input end
		end)
		UserInputService.InputChanged:Connect(function(Input)
			if Input == DragInput and Dragging then
				local Delta = Input.Position - MousePos
				TweenService:Create(Main, TweenInfo.new(0.4, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {Position = UDim2.new(FramePos.X.Scale,FramePos.X.Offset + Delta.X, FramePos.Y.Scale, FramePos.Y.Offset + Delta.Y)}):Play()
			end
		end)
	end)
end

local function Create(Name, Props, Children)
	local Object = Instance.new(Name)
	for i,v in next, Props or {} do Object[i]=v end
	for i,v in next, Children or {} do v.Parent=Object end
	return Object
end

local function CreateElement(Name, Fn)
	DexorUI.Elements[Name] = function(...) return Fn(...) end
end

local function MakeElement(Name, ...)
	return DexorUI.Elements[Name](...)
end

local function SetProps(Element, Props)
	for Property,Value in pairs(Props) do Element[Property]=Value end
	return Element
end

local function SetChildren(Element, Children)
	for _,Child in pairs(Children) do Child.Parent=Element end
	return Element
end

local function Round(Number,Factor)
	local Result=math.floor(Number/Factor+(math.sign(Number)*0.5))*Factor
	if Result<0 then Result=Result+Factor end
	return Result
end

-- DexorUI - Elemente und Window-Logic

local DexorScreenGui = Instance.new("ScreenGui")
DexorScreenGui.Name = "DexorUI"
DexorScreenGui.IgnoreGuiInset = true
DexorScreenGui.Parent = gethui() or game.CoreGui

local function AddThemeObject(Object, Type)
	if not DexorUI.ThemeObjects[Type] then DexorUI.ThemeObjects[Type] = {} end
	table.insert(DexorUI.ThemeObjects[Type], Object)
	return Object
end

local function ReturnProperty(Object)
	if Object:IsA("Frame") or Object:IsA("TextButton") then
		return "BackgroundColor3"
	end
	if Object:IsA("TextLabel") or Object:IsA("TextBox") then
		return "TextColor3"
	end
end

local function SetTheme()
	for Name, Type in pairs(DexorUI.ThemeObjects) do
		for _, Object in pairs(Type) do
			Object[ReturnProperty(Object)] = DexorUI.Themes[DexorUI.SelectedTheme][Name]
		end
	end
end

-- Simple MakeElement defs (kannst selber erweitern!)
CreateElement("Corner", function(Scale, Offset)
	return Create("UICorner", {CornerRadius = UDim.new(Scale or 0, Offset or 8)})
end)

CreateElement("Stroke", function(Color, Thickness)
	return Create("UIStroke", {Color = Color or Color3.fromRGB(255, 255, 255), Thickness = Thickness or 1})
end)

CreateElement("List", function(Pad)
	return Create("UIListLayout", {SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, Pad or 4)})
end)

CreateElement("Label", function(Text, Size)
	return Create("TextLabel", {
		Text = Text or "",
		TextColor3 = Color3.fromRGB(230, 230, 230),
		TextSize = Size or 15,
		Font = Enum.Font.Gotham,
		BackgroundTransparency = 1,
		TextXAlignment = Enum.TextXAlignment.Left
	})
end)

CreateElement("Button", function()
	return Create("TextButton", {
		Text = "",
		AutoButtonColor = false,
		BackgroundTransparency = 1,
		BorderSizePixel = 0
	})
end)

CreateElement("RoundFrame", function(Color, Scale, Offset)
	return Create("Frame", {
		BackgroundColor3 = Color or Color3.fromRGB(255, 255, 255),
		BorderSizePixel = 0
	}, {
		Create("UICorner", {CornerRadius = UDim.new(Scale, Offset)})
	})
end)

-- Main Window
function DexorUI:MakeWindow(WindowConfig)
	WindowConfig = WindowConfig or {}
	WindowConfig.Name = WindowConfig.Name or "Dexor UI"
	WindowConfig.Size = WindowConfig.Size or UDim2.new(0, 610, 0, 350)
	WindowConfig.Position = WindowConfig.Position or UDim2.new(0.5, -305, 0.5, -175)

	local MainWindow = AddThemeObject(SetChildren(SetProps(MakeElement("RoundFrame", DexorUI.Themes.Default.Main, 0, 10), {
		Parent = DexorScreenGui,
		Size = WindowConfig.Size,
		Position = WindowConfig.Position,
		ClipsDescendants = true
	}), {
		MakeElement("Stroke", DexorUI.Themes.Default.Stroke, 1.5),
		MakeElement("Corner", 0, 10)
	}), "Main")

	local TopBar = SetProps(MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 10), {
		Parent = MainWindow,
		Size = UDim2.new(1, 0, 0, 44),
		Position = UDim2.new(0, 0, 0, 0),
		Name = "TopBar"
	})

	AddDraggingFunctionality(TopBar, MainWindow)

	local Title = SetProps(MakeElement("Label", WindowConfig.Name, 19), {
		Parent = TopBar,
		Size = UDim2.new(1, -24, 1, 0),
		Position = UDim2.new(0, 18, 0, 0),
		Font = Enum.Font.GothamBlack,
		TextXAlignment = Enum.TextXAlignment.Left
	})

	local TabHolder = SetProps(MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 8), {
		Parent = MainWindow,
		Size = UDim2.new(0, 140, 1, -44),
		Position = UDim2.new(0, 0, 0, 44)
	})
	MakeElement("List", 0, 3).Parent = TabHolder

	local ContentFrame = SetProps(MakeElement("RoundFrame", DexorUI.Themes.Default.Main, 0, 8), {
		Parent = MainWindow,
		Size = UDim2.new(1, -140, 1, -44),
		Position = UDim2.new(0, 140, 0, 44),
		Name = "ContentFrame"
	})

	MakeElement("List", 0, 8).Parent = ContentFrame

	-- Tab function
	local function MakeTab(TabConfig)
		TabConfig = TabConfig or {}
		TabConfig.Name = TabConfig.Name or "Tab"

		local TabBtn = SetProps(MakeElement("Button"), {
			Parent = TabHolder,
			Size = UDim2.new(1, 0, 0, 32)
		})

		local TabLbl = SetProps(MakeElement("Label", TabConfig.Name, 15), {
			Parent = TabBtn,
			Size = UDim2.new(1, -18, 1, 0),
			Position = UDim2.new(0, 8, 0, 0)
		})

		local TabContent = SetProps(MakeElement("RoundFrame", DexorUI.Themes.Default.Main, 0, 8), {
			Parent = ContentFrame,
			Size = UDim2.new(1, 0, 1, 0),
			Visible = false,
			Name = "TabContent"
		})
		MakeElement("List", 0, 10).Parent = TabContent

		TabBtn.MouseButton1Click:Connect(function()
			for _, v in pairs(ContentFrame:GetChildren()) do
				if v:IsA("Frame") and v.Name == "TabContent" then v.Visible = false end
			end
			TabContent.Visible = true
		end)

		if #ContentFrame:GetChildren() == 1 then
			TabContent.Visible = true
		end

		-- Section/AddElement logic folgt in Teil 3!

		return TabContent
	end

	return {
		MakeTab = MakeTab
	}
end

--========================================================--
--  DEXOR UI â€“ ELEMENT FUNKTIONEN
--========================================================--

function DexorUI:CreateElements(Parent)
    local Elements = {}

    ---------------------------------------------------------
    -- LABEL
    ---------------------------------------------------------
    function Elements:AddLabel(Text)
        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 26)

        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Text, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 3)

        return {
            Set = function(_, new)
                Label.Text = new
            end
        }
    end

    ---------------------------------------------------------
    -- PARAGRAPH
    ---------------------------------------------------------
    function Elements:AddParagraph(Title, Content)
        local Holder = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Holder.Parent = Parent
        Holder.AutomaticSize = Enum.AutomaticSize.Y
        Holder.Size = UDim2.new(1, 0, 0, 40)

        MakeElement("Stroke").Parent = Holder

        local TitleLbl = MakeElement("Label", Title, 15)
        TitleLbl.Parent = Holder
        TitleLbl.Font = Enum.Font.GothamBold
        TitleLbl.Position = UDim2.new(0, 10, 0, 4)

        local ContentLbl = MakeElement("Label", Content, 13)
        ContentLbl.Parent = Holder
        ContentLbl.Position = UDim2.new(0, 10, 0, 22)
        ContentLbl.Size = UDim2.new(1, -20, 0, 0)
        ContentLbl.RichText = true
        ContentLbl.AutomaticSize = Enum.AutomaticSize.Y

        return {
            Set = function(_, new)
                ContentLbl.Text = new
            end
        }
    end

    ---------------------------------------------------------
    -- BUTTON
    ---------------------------------------------------------
    function Elements:AddButton(Config)
        Config = Config or {}
        Config.Name = Config.Name or "Button"
        Config.Callback = Config.Callback or function() end

        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 32)
        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Config.Name, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 3)

        local Click = MakeElement("Button")
        Click.Parent = Frame
        Click.Size = UDim2.new(1, 0, 1, 0)

        Click.MouseButton1Up:Connect(function()
            task.spawn(Config.Callback)
        end)

        return {
            Set = function(_, txt)
                Label.Text = txt
            end
        }
    end

    ---------------------------------------------------------
    -- TOGGLE
    ---------------------------------------------------------
    function Elements:AddToggle(Config)
        Config = Config or {}
        Config.Name = Config.Name or "Toggle"
        Config.Default = Config.Default or false
        Config.Callback = Config.Callback or function() end

        local toggleValue = Config.Default

        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 38)
        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Config.Name, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 8)

        local Box = MakeElement("RoundFrame", Config.Color or Color3.fromRGB(9, 140, 250), 0, 5)
        Box.Parent = Frame
        Box.Size = UDim2.new(0, 24, 0, 24)
        Box.Position = UDim2.new(1, -30, 0, 7)
        local Stroke = MakeElement("Stroke")
        Stroke.Parent = Box

        local Ico = MakeElement("Image", "rbxassetid://3944680095")
        Ico.Parent = Box
        Ico.Size = UDim2.new(0, 18, 0, 18)
        Ico.Position = UDim2.new(0.5, -9, 0.5, -9)

        local Click = MakeElement("Button")
        Click.Parent = Frame
        Click.Size = UDim2.new(1, 0, 1, 0)

        local function Set(v)
            toggleValue = v
            TweenService:Create(Ico, TweenInfo.new(0.25), {ImageTransparency = v and 0 or 1}):Play()
            TweenService:Create(Box, TweenInfo.new(0.25), {
                BackgroundColor3 = v and (Config.Color or Color3.fromRGB(9, 140, 250))
                    or DexorUI.Themes.Default.Divider
            }):Play()
            task.spawn(Config.Callback, v)
        end

        Set(Config.Default)

        Click.MouseButton1Up:Connect(function()
            Set(not toggleValue)
        end)

        return {
            Set = Set
        }
    end

    ---------------------------------------------------------
    -- SLIDER
    ---------------------------------------------------------
    function Elements:AddSlider(Config)
        Config = Config or {}
        Config.Name = Config.Name or "Slider"
        Config.Min = Config.Min or 0
        Config.Max = Config.Max or 100
        Config.Default = Config.Default or 50
        Config.Increment = Config.Increment or 1
        Config.Callback = Config.Callback or function() end

        local val = Config.Default

        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 60)
        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Config.Name, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 5)

        local Bar = MakeElement("RoundFrame", Config.Color or Color3.fromRGB(9, 140, 250), 0, 5)
        Bar.Parent = Frame
        Bar.BackgroundTransparency = 0.5
        Bar.Size = UDim2.new(1, -20, 0, 26)
        Bar.Position = UDim2.new(0, 10, 0, 28)

        local Drag = MakeElement("RoundFrame", Config.Color or Color3.fromRGB(9, 140, 250), 0, 5)
        Drag.Parent = Bar
        Drag.Size = UDim2.new(0, 0, 1, 0)

        local ValueLabel = MakeElement("Label", "0", 13)
        ValueLabel.Parent = Drag
        ValueLabel.Position = UDim2.new(0, 8, 0, 4)

        local function Set(v)
            v = math.clamp(math.floor(v / Config.Increment + 0.5) * Config.Increment, Config.Min, Config.Max)
            val = v
            local percent = (v - Config.Min) / (Config.Max - Config.Min)
            Drag.Size = UDim2.fromScale(percent, 1)
            ValueLabel.Text = tostring(v)
            Config.Callback(v)
        end

        Bar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                local con
                con = RunService.RenderStepped:Connect(function()
                    local pos = math.clamp(Mouse.X - Bar.AbsolutePosition.X, 0, Bar.AbsoluteSize.X)
                    local percent = pos / Bar.AbsoluteSize.X
                    Set(Config.Min + (Config.Max - Config.Min) * percent)
                end)
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        con:Disconnect()
                    end
                end)
            end
        end)

        Set(Config.Default)

        return {
            Set = Set
        }
    end

    ---------------------------------------------------------
    -- TEXTBOX
    ---------------------------------------------------------
    function Elements:AddTextbox(Config)
        Config = Config or {}
        Config.Name = Config.Name or "Textbox"
        Config.Default = Config.Default or ""
        Config.Callback = Config.Callback or function() end

        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 38)
        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Config.Name, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 8)

        local Box = Instance.new("TextBox")
        Box.Parent = Frame
        Box.Size = UDim2.new(0, 120, 0, 24)
        Box.Position = UDim2.new(1, -130, 0.5, -12)
        Box.BackgroundTransparency = 1
        Box.TextColor3 = Color3.fromRGB(255,255,255)
        Box.Text = Config.Default
        Box.Font = Enum.Font.GothamBold
        Box.TextSize = 14

        Box.FocusLost:Connect(function()
            Config.Callback(Box.Text)
        end)

        return {
            Set = function(_, txt)
                Box.Text = txt
            end
        }
    end

    ---------------------------------------------------------
    -- DROPDOWN
    ---------------------------------------------------------
    function Elements:AddDropdown(Config)
        Config = Config or {}
        Config.Name = Config.Name or "Dropdown"
        Config.Options = Config.Options or {}
        Config.Default = Config.Default or Config.Options[1]
        Config.Callback = Config.Callback or function() end

        local opened = false
        local current = Config.Default

        local Frame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        Frame.Parent = Parent
        Frame.Size = UDim2.new(1, 0, 0, 38)
        MakeElement("Stroke").Parent = Frame

        local Label = MakeElement("Label", Config.Name, 15)
        Label.Parent = Frame
        Label.Position = UDim2.new(0, 10, 0, 8)

        local Selected = MakeElement("Label", tostring(Config.Default), 14)
        Selected.Parent = Frame
        Selected.TextXAlignment = Enum.TextXAlignment.Right
        Selected.Position = UDim2.new(1, -35, 0, 8)

        local Click = MakeElement("Button")
        Click.Parent = Frame
        Click.Size = UDim2.new(1, 0, 1, 0)

        local ListFrame = MakeElement("RoundFrame", DexorUI.Themes.Default.Second, 0, 6)
        ListFrame.Parent = Parent
        ListFrame.Size = UDim2.new(1, 0, 0, 0)
        ListFrame.ClipsDescendants = true
        MakeElement("Stroke").Parent = ListFrame

        local ListLayout = MakeElement("List", 4)
        ListLayout.Parent = ListFrame

        local function Refresh()
            for _, c in pairs(ListFrame:GetChildren()) do
                if c:IsA("TextButton") then c:Destroy() end
            end

            for _, opt in ipairs(Config.Options) do
                local Btn = MakeElement("Button")
                Btn.Parent = ListFrame
                Btn.Size = UDim2.new(1, 0, 0, 28)

                local T = MakeElement("Label", opt, 14)
                T.Parent = Btn
                T.Position = UDim2.new(0, 10, 0, 6)

                Btn.MouseButton1Up:Connect(function()
                    current = opt
                    Selected.Text = opt
                    Config.Callback(opt)
                end)
            end
        end

        Refresh()

        Click.MouseButton1Up:Connect(function()
            opened = not opened
            TweenService:Create(ListFrame, TweenInfo.new(0.2), {
                Size = opened and UDim2.new(1, 0, 0, (#Config.Options * 32)) or UDim2.new(1, 0, 0, 0)
            }):Play()
        end)

        return {
            Set = function(_, v)
                current = v
                Selected.Text = v
            end,
            Refresh = function(_, new)
                Config.Options = new
                Refresh()
            end
        }
    end

    return Elements
end

--========================================================--
-- SECTION FUNKTION
--========================================================--

function DexorUI:CreateSection(Parent, Name)
    local Section = MakeElement("RoundFrame", DexorUI.Themes.Default.Main, 0, 6)
    Section.Parent = Parent
    Section.AutomaticSize = Enum.AutomaticSize.Y
    Section.Size = UDim2.new(1, 0, 0, 32)

    local Title = MakeElement("Label", Name, 15)
    Title.Parent = Section
    Title.Font = Enum.Font.GothamBold
    Title.Position = UDim2.new(0, 10, 0, 6)

    local Holder = MakeElement("TFrame")
    Holder.Parent = Section
    Holder.Position = UDim2.new(0, 0, 0, 28)
    Holder.Size = UDim2.new(1, 0, 1, -28)

    MakeElement("List", 6).Parent = Holder

    return self:CreateElements(Holder)
end

return DexorUI
